{% extends "base.html" %}

{% block content %}
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/main">
                <i class="bi bi-compass"></i> Cliff Jump Registry
            </a>

            <div class="d-flex align-items-center">
                <span class="navbar-text text-white me-3">
                    <i class="bi bi-person-circle"></i> {{ me.username }}
                    {% if me.user_type != 'guest' %}
                        ({{ me.user_type }})
                    {% endif %}
                </span>

                {% if me.user_type == 'admin' %}
                <!-- Admin Dropdown Menu -->
                <div class="dropdown me-2">
                    <button class="btn btn-light dropdown-toggle" type="button" id="adminDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-gear-fill"></i> Admin
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/users/manage"><i class="bi bi-people"></i> List All Users</a></li>
                        <li><a class="dropdown-item" href="/users/manage?pkval=new"><i class="bi bi-person-plus"></i> Add New User</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/locations/manage"><i class="bi bi-geo-alt"></i> Manage Locations</a></li>
                    </ul>
                </div>
                {% endif %}

                {% if me.user_type == 'guest' %}
                <!-- Guest: Show Login and Register buttons -->
                <a href="/login" class="btn btn-light me-2">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </a>
                <a href="/register" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Register
                </a>
                {% else %}
                <!-- Logged in users: Show Logout button -->
                <a href="/logout" class="btn btn-outline-light">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">

	<!-- Map Container -->
	<div id="map" style="width: 100%; height: 600px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>

	<!-- Map Controls -->
	<div class="mt-3 d-flex justify-content-between align-items-center">
		<div>
			{% if me.user_type != 'guest' %}
			<button id="addLocationBtn" class="btn btn-success btn-lg" onclick="toggleAddMode()">
				<i class="bi bi-plus-circle"></i> Add New Location
			</button>
			{% else %}
			<div class="alert alert-info mb-0">
				<i class="bi bi-info-circle"></i> <a href="/login" class="alert-link">Login</a> or <a href="/register" class="alert-link">Register</a> to add locations
			</div>
			{% endif %}
		</div>
		<a href="/locations/manage" class="btn btn-primary">
			<i class="bi bi-list-ul"></i> View All Locations
		</a>
	</div>
	</div> <!-- Close container-fluid -->

	<!-- Add Location Modal (Bootstrap Modal) -->
	<div class="modal fade" id="addLocationModal" tabindex="-1" aria-labelledby="addLocationModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header bg-success text-white">
					<h5 class="modal-title" id="addLocationModalLabel">
						<i class="bi bi-geo-alt-fill"></i> Add New Location
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="modalContent">
					<!-- Form will be loaded here via AJAX -->
				</div>
			</div>
		</div>
	</div>

	<!-- Mapbox JS -->
	<script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
	<script>
		// Mapbox token loaded from config.yml
		mapboxgl.accessToken = '{{ mapbox_token }}';

		const map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/outdoors-v12', // Outdoors style with topo lines and terrain
			center: [-72.9906, 44.1265], // Lincoln, Vermont
			zoom: 12, // Zoomed in to show local terrain detail
			pitch: 0, // Looking straight down
			bearing: 0
		});

		// Add navigation controls
		map.addControl(new mapboxgl.NavigationControl());

		// Add terrain and 3D buildings
		map.on('load', () => {
			// Add terrain source
			map.addSource('mapbox-dem', {
				'type': 'raster-dem',
				'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
				'tileSize': 512,
				'maxzoom': 14
			});

			// Add terrain layer with exaggeration
			map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

			// Add sky layer for better 3D effect
			map.addLayer({
				'id': 'sky',
				'type': 'sky',
				'paint': {
					'sky-type': 'atmosphere',
					'sky-atmosphere-sun': [0.0, 90.0],
					'sky-atmosphere-sun-intensity': 15
				}
			});

			// Load location markers after terrain is set up
			setTimeout(loadLocationMarkers, 500);
		});

		// Global variables
		let locationMarkers = [];
		let addLocationMode = false;

		// Function to toggle add location mode
		function toggleAddMode() {
			addLocationMode = !addLocationMode;
			const btn = document.getElementById('addLocationBtn');

			if (addLocationMode) {
				btn.classList.remove('btn-success');
				btn.classList.add('btn-warning');
				btn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel (Click map to add)';
				map.getCanvas().style.cursor = 'crosshair';
			} else {
				btn.classList.remove('btn-warning');
				btn.classList.add('btn-success');
				btn.innerHTML = '<i class="bi bi-plus-circle"></i> Add New Location';
				map.getCanvas().style.cursor = '';
			}
		}

		// Function to load and display location markers
		function loadLocationMarkers() {
			fetch('/api/locations')
				.then(response => response.json())
				.then(geojson => {
					// Remove existing markers
					locationMarkers.forEach(marker => marker.remove());
					locationMarkers = [];

					// Add source and layer if not exists
					if (!map.getSource('locations')) {
						map.addSource('locations', {
							type: 'geojson',
							data: geojson
						});

						// Add layer for markers
						map.addLayer({
							id: 'location-markers',
							type: 'circle',
							source: 'locations',
							paint: {
								'circle-radius': 10,
								'circle-color': '#0066cc',  // Blue color for all locations
								'circle-stroke-width': 2,
								'circle-stroke-color': '#ffffff'
							}
						});

						// Add labels
						map.addLayer({
							id: 'location-labels',
							type: 'symbol',
							source: 'locations',
							layout: {
								'text-field': ['get', 'name'],
								'text-size': 12,
								'text-offset': [0, 1.5],
								'text-anchor': 'top'
							},
							paint: {
								'text-color': '#000000',
								'text-halo-color': '#ffffff',
								'text-halo-width': 2
							}
						});
					} else {
						// Update existing source
						map.getSource('locations').setData(geojson);
					}

					// Add click handler for markers
					map.on('click', 'location-markers', (e) => {
						const feature = e.features[0];
						const props = feature.properties;

						// Create initial popup with loading message
						const popup = new mapboxgl.Popup()
							.setLngLat(e.lngLat)
							.setHTML('<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading jump points...</div>')
							.addTo(map);

						// Fetch jump points for this location
						fetch(`/api/jumppoints/${props.location_id}`)
							.then(response => response.json())
							.then(data => {
								const jumps = data.jumps;

								// Build popup content with jump points
								let popupContent = `
									<div style="max-width: 350px;">
										<h4 class="mb-2"><i class="bi bi-geo-alt-fill"></i> ${props.name}</h4>
										${props.description ? `<p class="small text-muted">${props.description}</p>` : ''}
										<hr class="my-2">
								`;

								if (jumps.length > 0) {
									popupContent += '<h6 class="mb-2">Jump Points:</h6><div class="list-group list-group-flush">';
									jumps.forEach(jump => {
										// Status badge
										let statusBadge = '';
										if (jump.status === 'dangerous') {
											statusBadge = '<span class="badge bg-danger ms-1">âš  Dangerous</span>';
										} else if (jump.status === 'closed') {
											statusBadge = '<span class="badge bg-secondary ms-1">Closed</span>';
										}

										// Difficulty badge
										let difficultyBadge = jump.difficulty ?
											`<span class="badge bg-info ms-1">${jump.difficulty}</span>` : '';

										popupContent += `
											<div class="list-group-item px-2 py-2">
												<div class="d-flex justify-content-between align-items-start">
													<div>
														<strong>${jump.name}</strong>
														${jump.height_feet ? `<span class="text-muted">(${jump.height_feet} ft)</span>` : ''}
														${difficultyBadge}
														${statusBadge}
													</div>
												</div>
												${jump.position_description ? `<small class="text-muted d-block mt-1"><i class="bi bi-pin-map"></i> ${jump.position_description}</small>` : ''}
												${jump.description ? `<small class="d-block mt-1">${jump.description}</small>` : ''}
												${jump.dangers ? `<small class="text-danger d-block mt-1"><i class="bi bi-exclamation-triangle"></i> ${jump.dangers}</small>` : ''}
											</div>
										`;
									});
									popupContent += '</div>';
								} else {
									popupContent += '<p class="text-muted mb-2"><i class="bi bi-info-circle"></i> No jump points added yet.</p>';
								}

								// Add buttons
								popupContent += '<hr class="my-2"><div class="d-flex justify-content-between gap-2">';

								{% if me.user_type != 'guest' %}
								popupContent += `<a href="/jumppoints/manage?pkval=new&location_id=${props.location_id}" class="btn btn-sm btn-success flex-fill"><i class="bi bi-plus-circle"></i> Add Jump</a>`;
								{% endif %}

								{% if me.user_type == 'admin' or me.user_type == 'trusted' %}
								popupContent += `<a href="/locations/manage?pkval=${props.location_id}" class="btn btn-sm btn-outline-primary flex-fill"><i class="bi bi-pencil"></i> Edit Area</a>`;
								{% endif %}

								popupContent += '</div></div>';

								popup.setHTML(popupContent);
							})
							.catch(error => {
								console.error('Error loading jump points:', error);
								popup.setHTML(`
									<div>
										<h4>${props.name}</h4>
										<p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error loading jump points</p>
									</div>
								`);
							});
					});

					// Change cursor on hover
					map.on('mouseenter', 'location-markers', () => {
						map.getCanvas().style.cursor = 'pointer';
					});

					map.on('mouseleave', 'location-markers', () => {
						map.getCanvas().style.cursor = '';
					});
				})
				.catch(error => {
					console.error('Error loading locations:', error);
				});
		}

		// Map click handler to add new location
		map.on('click', (e) => {
			// Check if click was on a marker (if so, don't open add modal)
			const features = map.queryRenderedFeatures(e.point, {
				layers: ['location-markers']
			});

			if (features.length > 0) {
				return; // Clicked on existing marker, popup will show
			}

			// Only open modal if in add mode
			if (addLocationMode) {
				const lat = e.lngLat.lat.toFixed(6);
				const lng = e.lngLat.lng.toFixed(6);

				openAddLocationModal(lat, lng);
				toggleAddMode(); // Exit add mode after clicking
			}
		});

		// Function to open the add location modal
		function openAddLocationModal(lat, lng) {
			// Get Bootstrap modal instance
			const modalElement = document.getElementById('addLocationModal');
			const modal = new bootstrap.Modal(modalElement);

			// Load the add form via AJAX
			fetch(`/locations/manage?pkval=new`)
				.then(response => response.text())
				.then(html => {
					// Extract just the form content (parse the full HTML response)
					const parser = new DOMParser();
					const doc = parser.parseFromString(html, 'text/html');
					const formContent = doc.querySelector('form').parentElement.innerHTML;

					document.getElementById('modalContent').innerHTML = formContent;

					// Pre-fill latitude and longitude
					document.getElementById('latitude').value = lat;
					document.getElementById('longitude').value = lng;

					// Intercept form submission to handle via AJAX
					const form = document.getElementById('addLocationForm');
					form.onsubmit = function(e) {
						e.preventDefault();

						// Submit form via AJAX
						const formData = new FormData(form);

						fetch('/locations/manage?action=insert', {
							method: 'POST',
							body: formData
						})
						.then(response => response.text())
						.then(html => {
							// Check if response contains errors or success
							if (html.includes('error_text') || html.includes('cannot be blank')) {
								// Show errors in modal
								const parser = new DOMParser();
								const doc = parser.parseFromString(html, 'text/html');
								const formContent = doc.querySelector('form').parentElement.innerHTML;
								document.getElementById('modalContent').innerHTML = formContent;

								// Re-attach form handler
								const newForm = document.getElementById('addLocationForm');
								newForm.onsubmit = arguments.callee;  // Reattach same handler
							} else {
								// Success - close modal and reload markers
								bootstrap.Modal.getInstance(modalElement).hide();
								loadLocationMarkers();

								// Show success toast/alert
								const alertDiv = document.createElement('div');
								alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
								alertDiv.style.zIndex = '9999';
								alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> Location added successfully! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
								document.body.appendChild(alertDiv);
								setTimeout(() => alertDiv.remove(), 3000);
							}
						})
						.catch(error => {
							console.error('Error submitting form:', error);
							alert('Error adding location. Please try again.');
						});
					};
				})
				.catch(error => {
					console.error('Error loading form:', error);
					document.getElementById('modalContent').innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error loading form. Please try again.</div>';
				});

			// Show the modal
			modal.show();
		}
	</script>

{% endblock %}